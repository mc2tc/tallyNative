# Next.js API Contract for React Native App

This document outlines the API contract and architectural expectations between the React Native (RN) mobile app and the Next.js backend. The RN app follows a **thin client architecture** where it handles UI/UX only and delegates all business logic, data validation, and privileged operations to Next.js APIs.

---

## 1. Architecture Principles

### 1.1 Thin Client Pattern

The RN app is designed as a **thin client** that:

- ✅ Handles UI rendering, navigation, and user interactions
- ✅ Makes authenticated API calls to Next.js
- ✅ Manages local UI state (loading, errors, form inputs)
- ✅ Caches auth state for UX (but always validates with server)
- ❌ **Does NOT** perform business logic or data validation
- ❌ **Does NOT** write directly to Firestore (except reads allowed by rules)
- ❌ **Does NOT** make security decisions (only UI visibility based on permissions)

### 1.2 Trust Boundary

**All trust boundaries are server-side:**

- Authentication validation happens in Next.js
- Permission checks happen in Next.js
- Data validation happens in Next.js
- Business rules are enforced in Next.js

The RN app trusts the Next.js API responses and uses them to render UI accordingly.

---

## 2. Authentication & Authorization

### 2.1 Authentication Flow

1. **User signs in** via Firebase Auth SDK in RN
2. **RN retrieves ID token** using `currentUser.getIdToken()`
3. **RN attaches token** to all API requests as `Authorization: Bearer <token>`
4. **Next.js validates token** and extracts user info
5. **Next.js returns** user data, memberships, and permissions

### 2.2 Token Handling

**RN expects:**

- All API endpoints accept `Authorization: Bearer <firebase-id-token>` header
- Token validation happens server-side
- Invalid/expired tokens return `401 Unauthorized`
- RN will refresh tokens automatically and retry requests

**Next.js should:**

- Validate Firebase ID tokens on every request
- Return `401` for invalid/expired tokens
- Return `403` for valid tokens but insufficient permissions

### 2.3 Auth State Endpoint

**Endpoint:** `POST /api/auth/claims/refresh`

**Request:**

```http
POST /api/auth/claims/refresh
Authorization: Bearer <firebase-id-token>
```

**Expected Response (200 OK):**

```json
{
  "claims": {
    "businessMemberships": {
      "businessId1": { "role": "owner", "permissions": "all" },
      "businessId2": {
        "role": "super",
        "permissions": ["view_transactions", "view_financial_reports"]
      }
    }
  },
  "memberships": {
    "businessId1": {
      "role": "owner",
      "permissions": "all"
    },
    "businessId2": {
      "role": "super",
      "permissions": ["view_transactions", "view_financial_reports"]
    }
  }
}
```

**Notes:**

- RN uses this to hydrate local auth state
- Called after login, business creation, invite acceptance
- Should return both custom claims AND fallback memberships (from Firestore if claims missing)
- `permissions` can be `"all"` (for owners) or an array of permission strings

---

## 3. API Endpoints Required

### 3.1 Owner Bootstrap

**Endpoint:** `POST /api/auth/bootstrap-owner`

**Request:**

```json
{
  "owner": {
    "firstName": "John",
    "lastName": "Doe",
    "email": "john@example.com"
  },
  "businesses": [
    {
      "businessName": "My Business",
      "location": { ... },
      "category": { ... },
      "settings": { ... },
      "bankAccounts": [],
      "creditCards": [],
      "isVatRegistered": false,
      "vatRegistrationNumber": null,
      "businessStage": "startup",
      "businessEntity": "llc",
      "softwareTypes": { ... }
    }
  ],
  "createPersonalBusiness": true
}
```

**Note:**

- `businesses` array is optional (if empty and `createPersonalBusiness` is true, only personal business is created)
- All fields in business objects except `businessName` are optional
- `ownerId` and `businessId` values are auto-generated by the server

**Expected Response (201 Created):**

```json
{
  "ownerId": "JohnDoe_abc123",
  "businesses": [
    { "id": "MyBusiness_xyz789", "name": "My Business" },
    { "id": "JohnDoePersonal_def456", "name": "John Doe Personal" }
  ]
}
```

**Error Responses:**

- `400` - Invalid input (with `{ "error": "message" }`)
- `401` - Unauthenticated
- `500` - Internal server error

---

### 3.2 Business Creation

**Endpoint:** `POST /api/auth/businesses`

**Request:**

```json
{
  "business": {
    "name": "New Business",
    "location": { ... },
    "category": { ... },
    "settings": { ... },
    "bankAccounts": [],
    "creditCards": [],
    "isVatRegistered": false,
    "vatRegistrationNumber": null,
    "businessStage": "startup",
    "businessEntity": "llc",
    "softwareTypes": { ... }
  }
}
```

**Note:**

- Request must be wrapped in `business` key
- All fields except `name` are optional
- `businessId` is auto-generated by the server (format: `{BusinessName}_{RandomSuffix}`)

**Expected Response (201 Created):**

```json
{
  "businessId": "NewBusiness_abc123"
}
```

**Error Responses:**

- `400` - Invalid input (e.g., missing `business` key or `name` field)
- `401` - Unauthenticated
- `403` - Not an owner (only owners can create businesses)
- `500` - Internal server error

---

### 3.3 Invite Creation

**Endpoint:** `POST /api/auth/invites`

**Request:**

```json
{
  "businessId": "business123",
  "email": "invitee@example.com",
  "firstName": "Jane",
  "lastName": "Smith",
  "role": "super",
  "permissions": ["view_transactions", "view_financial_reports"]
}
```

**Note:**

- `firstName` and `lastName` are required
- `permissions` is optional for `super` role (they automatically get all permissions)
- `permissions` is required for `other` role
- Invites expire after **7 days** from creation

**Expected Response (201 Created):**

```json
{
  "inviteId": "invite123"
}
```

**Error Responses:**

- `400` - Invalid input (missing required fields)
- `401` - Unauthenticated
- `403` - Not authorized to create invites for this business (not an owner)
- `409` - User already has access
- `500` - Internal server error

---

### 3.4 Invite Acceptance

**Endpoint:** `POST /api/auth/invites/{inviteId}/accept`

**Request (optional):**

```json
{
  "firstName": "Jane",
  "lastName": "Smith"
}
```

**Note:**

- Request body is optional
- If `firstName` or `lastName` are not provided, they will be taken from the invite data
- User's email must match the invite email
- Invite must be in `pending` status

**Expected Response (200 OK):**

```json
{
  "businessId": "business123",
  "role": "super"
}
```

**Error Responses:**

- `400` - Invalid input
- `401` - Unauthenticated
- `403` - Invite email mismatch (user email doesn't match invite email)
- `404` - Invite not found
- `409` - Invite already accepted
- `410` - Invite expired (invites expire after 7 days)
- `500` - Internal server error

---

### 3.5 Data Fetching Endpoints

**Pattern:** RN will call various data endpoints (transactions, businesses, reports, etc.)

**Expected Pattern:**

- `GET /api/businesses` - List user's businesses
- `GET /api/businesses/{businessId}/transactions` - List transactions
- `GET /api/businesses/{businessId}/reports` - Financial reports
- etc.

**Transactions2 API Endpoints:**

The RN app uses the `/authenticated/transactions2/api/*` endpoints:

- `GET /authenticated/transactions2/api/transactions?businessId={id}&page={page}&limit={limit}` - List transactions (already implemented)
- `GET /authenticated/transactions2/api/transactions/{transactionId}?businessId={id}` - Get single transaction by ID (needs implementation)
- `POST /authenticated/transactions2/api/receipts` - Process receipt OCR (already implemented)

**Transaction Detail Endpoint Requirements:**

For the transaction detail screen, implement:
- **Endpoint:** `GET /authenticated/transactions2/api/transactions/{transactionId}?businessId={businessId}`
- **Authentication:** Requires `Authorization: Bearer <firebase-id-token>` header
- **Authorization:** Validate user has `view_transactions` permission for the `businessId`
- **Response:** Returns a single `Transaction` object matching the type defined in `lib/api/transactions2.ts`:
  ```typescript
  type Transaction = {
    id: string
    metadata: TransactionMetadata
    summary: TransactionSummary
    accounting?: unknown
    details?: unknown
  }
  ```
- **Error Responses:**
  - `401` - Unauthorized (missing/invalid token)
  - `403` - Forbidden (no permission for this business)
  - `404` - Transaction not found or user doesn't have access

**Note:** Currently, the RN app passes the full transaction object via navigation params (which works for now), but implementing this endpoint will enable:
1. Fetching fresh data when opening the detail screen
2. Handling cases where transaction data might have been updated
3. Supporting deep linking to transaction details

**All should:**

- Require `Authorization: Bearer <token>` header
- Validate permissions server-side
- Return `403` if user lacks required permissions
- Return consistent error format (see Error Handling below)

---

## 4. Error Handling

### 4.1 Standard Error Response Format

**RN expects all errors to follow this format:**

```json
{
  "error": "Human-readable error message"
}
```

**HTTP Status Codes:**

- `400` - Bad Request (validation errors, invalid input)
- `401` - Unauthorized (missing/invalid token)
- `403` - Forbidden (valid token but insufficient permissions, or invite email mismatch)
- `404` - Not Found
- `409` - Conflict (e.g., duplicate email, invite already accepted)
- `410` - Gone (invite expired - invites expire after 7 days)
- `500` - Internal Server Error

### 4.2 Error Response Examples

**Validation Error (400):**

```json
{
  "error": "\"email\" must be a valid email address"
}
```

**Permission Error (403):**

```json
{
  "error": "You do not have permission to view this resource"
}
```

**Not Found (404):**

```json
{
  "error": "Business not found"
}
```

### 4.3 RN Error Handling

RN will:

- Display error messages to users
- Handle `401` by redirecting to sign-in
- Handle `403` by showing permission denied UI
- Retry requests with refreshed tokens on `401` (if possible)

---

## 5. Permission System

### 5.1 Permission Strings

RN expects permission strings like:

- `view_transactions`
- `view_financial_reports`
- `view_dashboard`
- `edit_transactions`
- `manage_users`
- etc.

**Owners** should receive `permissions: "all"` (string literal, not array).

### 5.2 Permission-Based Navigation

RN uses permissions to:

- Show/hide navigation items
- Enable/disable features
- Route users to appropriate screens

**Navigation Rules:**

- **Owners** → Business list screen
- **Supers** → Dashboard (if they have `businessId`)
- **Others** → First available module they have `view_*` permission for:
  1. `view_transactions` → transactions screen
  2. `view_financial_reports` → reports screen
  3. `view_dashboard` → dashboard
  4. Else → fallback/error screen

**Important:** RN uses permissions for **UI visibility only**. All security checks must happen server-side.

---

## 6. Type Definitions

### 6.1 Shared Types (for reference)

These types should match between Next.js and RN:

```typescript
type BusinessMembership = {
  role: 'owner' | 'super' | 'other';
  permissions: string[] | 'all';
};

type AuthClaimsResponse = {
  claims: {
    businessMemberships: Record<string, BusinessMembership>;
  };
  memberships: Record<string, BusinessMembership>;
};

type Business = {
  id: string;
  name: string;
  type: string;
  createdAt: string;
};

type Transaction = {
  id: string;
  businessId: string;
  amount: number;
  description: string;
  date: string;
  // ... other fields
};
```

**Recommendation:** Consider sharing types via:

- Shared npm package
- Monorepo with shared types package
- OpenAPI/Swagger spec generation
- Manual synchronization (document changes)

---

## 7. Environment Configuration

### 7.1 API Base URL

RN uses `EXPO_PUBLIC_API_BASE_URL` environment variable:

- Development: `http://localhost:3000` (iOS) or `http://10.0.2.2:3000` (Android emulator)
- Production: Your deployed Next.js domain

**Next.js should:**

- Support CORS for RN app origins (if needed)
- Handle both localhost and production domains
- Validate `Origin` header if implementing CORS

### 7.2 Firebase Configuration

- RN and Next.js use the **same Firebase project**
- Same auth providers enabled (email/password, Google, etc.)
- Same Firestore database
- Same security rules

---

## 8. Data Flow Examples

### 8.1 User Sign-Up Flow

1. RN: User fills sign-up form
2. RN: Creates Firebase Auth account
3. RN: Gets ID token
4. RN: Calls `POST /api/auth/bootstrap-owner` with token
5. Next.js: Validates token, creates owner, creates businesses
6. Next.js: Returns `{ ownerId, businesses: [{ id, name }, ...] }`
7. RN: Calls `POST /api/auth/claims/refresh` to get memberships
8. RN: Updates local auth state, navigates to business list

### 8.2 Viewing Transactions Flow

1. RN: User navigates to transactions screen
2. RN: Calls `GET /api/businesses/{businessId}/transactions` with token
3. Next.js: Validates token, checks `view_transactions` permission
4. Next.js: Returns transactions (or `403` if no permission)
5. RN: Renders transactions in UI

### 8.3 Invite Acceptance Flow

1. RN: User receives invite link (opens in app or web)
2. RN: User signs in (if not already) - email must match invite email
3. RN: Calls `POST /api/auth/invites/{inviteId}/accept` with token (optional firstName/lastName)
4. Next.js: Validates token, checks invite status and email match, creates user doc, grants access
5. Next.js: Returns `{ businessId, role }`
6. RN: Calls `POST /api/auth/claims/refresh` to get updated memberships
7. RN: Navigates to appropriate screen based on new permissions

---

## 9. Testing Expectations

### 9.1 Development Testing

**RN developer needs:**

- Next.js dev server running on `localhost:3000`
- Firebase project configured
- Test users with various permission levels
- Ability to test invite flow end-to-end

**Next.js developer should provide:**

- Clear instructions for local setup
- Test credentials for different roles
- Example API responses for documentation
- Postman/Insomnia collection (optional but helpful)

### 9.2 Integration Testing

Both projects should test:

- ✅ Token validation and refresh
- ✅ Permission checks (403 responses)
- ✅ Error handling (400, 401, 403, 404, 409, 410, 500)
- ✅ Owner bootstrap flow
- ✅ Invite creation and acceptance
- ✅ Invite expiry (410 response after 7 days)
- ✅ Business creation
- ✅ Data fetching with permissions

---

## 10. Breaking Changes & Versioning

### 10.1 API Versioning

**Current approach:** No versioning (all endpoints under `/api/*`)

**If versioning is needed:**

- Consider `/api/v1/*` pattern
- Document deprecation timeline
- Coordinate breaking changes with RN team

### 10.2 Change Communication

**When making breaking changes:**

1. Update this document
2. Notify RN team (via PR, issue, or direct communication)
3. Provide migration guide if needed
4. Consider backward compatibility period

**Breaking changes include:**

- Removing endpoints
- Changing request/response formats
- Changing error response format
- Changing permission strings
- Changing authentication requirements

---

## 11. Security Considerations

### 11.1 Server-Side Validation

**Critical:** Next.js must validate:

- ✅ All input data (never trust client)
- ✅ User permissions on every request
- ✅ Business ownership/access before operations
- ✅ Token validity and expiration
- ✅ Rate limiting (prevent abuse)

### 11.2 Firestore Rules

- RN app may read directly from Firestore (if rules allow)
- RN app should **NOT** write directly to Firestore for privileged operations
- All writes should go through Next.js APIs
- Firestore rules should mirror API permission checks

---

## 12. Future Considerations

### 12.1 Offline Support

If RN adds offline support:

- Will cache API responses locally
- Will sync when back online
- Next.js should support:
  - Optimistic update patterns
  - Conflict resolution
  - Last-modified timestamps

### 12.2 Real-Time Updates

If real-time features are needed:

- Consider WebSocket support or Server-Sent Events
- Or RN can poll endpoints periodically
- Coordinate with RN team on approach

### 12.3 Push Notifications

If push notifications are needed:

- RN will register device tokens
- Next.js will send notifications via FCM
- Coordinate on notification payload format

---

## 13. Additional Implementation Notes

### 13.1 Auto-Generated IDs

**Owner IDs:** Auto-generated by server in format `{FirstName}{LastName}_{RandomSuffix}` (e.g., `JohnDoe_abc123`)

**Business IDs:** Auto-generated by server in format `{BusinessName}_{RandomSuffix}` (e.g., `MyBusiness_xyz789`)

**Invite IDs:** Auto-generated by server (Firestore document ID)

### 13.2 Invite Expiry

- All invites expire after **7 days** from creation
- Expired invites return `410 Gone` status code
- Invite status can be: `pending`, `accepted`, `declined`, `expired`

### 13.3 Dev Override (Testing Only)

- Special user `martin@one-eleven-east.com` automatically gets `devOverride: true` in custom claims (non-production only)
- This allows access to all businesses' data for testing purposes
- Not relevant for RN app production use

### 13.4 Custom Claims Normalization

- Owners have `permissions: "all"` (string literal) in custom claims
- RN app should normalize this to a full array of permissions for UI checks
- Other roles have `permissions: string[]` (array of permission strings)

---

## 14. Contact & Coordination

**For questions or clarifications:**

- Update this document as the contract evolves
- Coordinate breaking changes before implementation
- Share API changes via PRs or issues
- Test integration changes together

---

**Last Updated:** 2024-12-19
**Maintained By:** Next.js Project Team
**RN App Version:** [Version]
**Next.js API Version:** [Version]
